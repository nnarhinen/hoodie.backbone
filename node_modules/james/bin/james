#!/usr/bin/env node

'use strict';

var fs    = require('fs'),
    cp    = require('child_process'),
    james = require(process.cwd() + '/node_modules/james/index.js'),
    jamesfile,
    runner;

if (fs.existsSync('./Jamesfile.js')) {
  jamesfile = './Jamesfile.js'

} else if (fs.existsSync('./Jamesfile.coffee')) {
  jamesfile = './Jamesfile.coffee'

} else {
  console.log("Error: Unable to find Jamesfile.")
  process.exit(1);
}

function runOnChildProcess() {
  console.log('Loading Jamesfile');
  if ( runner ) {
    runner.kill();
  }
  runner = cp.fork(__dirname + '/../lib/runner', process.argv.slice(2));
  runner.on('exit', runOnChildProcess);
}

if (process.argv.indexOf('watch') > -1) {
  runOnChildProcess();
  james.watch(jamesfile, runOnChildProcess);

} else {
  console.log('Loading Jamesfile');
  runner = require(__dirname + '/../lib/runner');
}
